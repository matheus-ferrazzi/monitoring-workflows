{
  "name": "RelatÃ³rios Zabbix",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 8,
              "triggerAtMinute": 1
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -704,
        1520
      ],
      "id": "9384862c-e184-4baf-946e-0c3ed0fa0461",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://url_chanell_teams",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        576,
        1520
      ],
      "id": "e11dbd95-a57d-489a-b2fd-1f092d815092",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://SEU_IP/zabbix/api_jsonrpc.php",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 5057adb1b8e6bf911778a274732412163a8b10d098211089c579ff78c461c723"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "=json",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "jsonBody": "={{\n  {\n    \"jsonrpc\": \"2.0\",\n    \"method\": \"item.get\",\n    \"params\": {\n        \"output\": [\"lastvalue\", \"key_\", \"hostid\"],\n        \"selectHosts\": [\"name\"],\n        \"hostids\": $('Config_IDs').first().json.meus_hosts,\n        \"search\": {\n            \"key_\": \"*pused*\"\n        },\n        \"searchWildcardsEnabled\": true,\n        \"sortfield\": \"name\"\n    },\n    \"id\": 2\n  }\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -144,
        1696
      ],
      "id": "a00324b7-6ff3-4a92-ad95-48fdba93d6f1",
      "name": "Get_Static"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://SEU_IP/zabbix/api_jsonrpc.php",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 5057adb1b8e6bf911778a274732412163a8b10d098211089c579ff78c461c723"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n  {\n    \"jsonrpc\": \"2.0\",\n    \"method\": \"item.get\",\n    \"params\": {\n        \"output\": [\"lastvalue\", \"key_\", \"hostid\"],\n        \"selectHosts\": [\"name\"],\n        \"hostids\": $('Config_IDs').first().json.meus_hosts,\n        \"filter\": {\n            \"key_\": [\n                \"service.info[\\\"MSSQLSERVER\\\",state]\",\n                \"system.cpu.util\",\n                \"vm.memory.util\",\n                \"vm.memory.utilization\",\n                \"system.memory.utilization\",\n                \"vm.memory.size[pused]\",\n                \"veeam.status[Bkp_DBMKT_VM]\",\n                \"veeam.status[Zabbix]\",\n                \"task.status[Backup_n8n]\",\n                \"task.status[Dump_Linux]\"\n            ]\n        }\n    },\n    \"id\": 1\n  }\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -144,
        1344
      ],
      "id": "593f1768-1afa-451f-bb7f-aaca5b15d850",
      "name": "Get_Disks"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        144,
        1504
      ],
      "id": "4e4ddeb9-dc62-403c-97b5-1500a0ac3498",
      "name": "Merge"
    },
    {
      "parameters": {
        "mode": "raw",
        "duplicateItem": true,
        "jsonOutput": "{\n  \"meus_hosts\": [\n    \"10657\",\n    \"10831\",\n    \"10853\",\n    \"10851\",\n    \"10658\"\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -480,
        1520
      ],
      "id": "0d36f0ec-b2f6-499c-9222-d7270d66e597",
      "name": "Config_IDs"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://SEU_IP/zabbix/api_jsonrpc.php",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer 5057adb1b8e6bf911778a274732412163a8b10d098211089c579ff78c461c723"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "=json",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "jsonBody": "={{\n  {\n    \"jsonrpc\": \"2.0\",\n    \"method\": \"problem.get\",\n    \"params\": {\n        \"output\": [\"name\", \"clock\", \"severity\", \"eventid\"],\n        \"selectHosts\": [\"name\"],\n        \"time_from\": Math.floor(Date.now() / 1000) - 43200, \n        \"sortfield\": [\"clock\"],\n        \"sortorder\": \"DESC\",\n        \"limit\": 5,\n        \"severities\": [3, 4, 5] \n    },\n    \"id\": 3\n  }\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -144,
        1520
      ],
      "id": "00389d0b-96ff-4499-8550-124f6d1b1df0",
      "name": "Get_Events"
    },
    {
      "parameters": {
        "jsCode": "let infraItems = [];\nlet eventItems = [];\n\n// 1. Separa o que Ã© Infraestrutura do que Ã© Evento/Alerta\n$input.all().forEach(nodeInput => {\n  if (nodeInput.json.result) {\n    nodeInput.json.result.forEach(item => {\n        if (item.eventid) {\n            eventItems.push(item);\n        } else {\n            infraItems.push(item);\n        }\n    });\n  }\n});\n\nif (infraItems.length === 0 && eventItems.length === 0) \n    return { \"type\": \"message\", \"body\": [{ \"text\": \"âš ï¸ Sem dados\" }] };\n\nconst backups = {}; \nconst servers = {}; \n\n// --- PROCESSAMENTO DE INFRA ---\ninfraItems.forEach(item => {\n  const key = item.key_;\n  const val = parseFloat(item.lastvalue);\n  const hostId = item.hostid;\n  const hostName = (item.hosts && item.hosts[0]) ? item.hosts[0].name : null;\n\n  if (!servers[hostId]) {\n    servers[hostId] = { \n        name: hostName || `Host ${hostId}`, \n        disks: [],\n        ram: \"N/A\", ramColor: \"Good\",\n        cpu: \"N/A\", cpuColor: \"Good\",\n        db: null, dbColor: \"Good\"\n    };\n  }\n  if (hostName && servers[hostId].name.includes(\"Host \")) servers[hostId].name = hostName;\n\n  if (key.includes(\"veeam.status\") || key.includes(\"task.status\")) {\n    backups[key] = (val == 1) ? \"âœ… SUCESSO\" : \"âŒ FALHA\";\n  } else {\n    if (key.includes(\"service.info\")) {\n        const isRunning = (val == 0);\n        servers[hostId].db = isRunning ? \"ON\" : \"OFF\";\n        servers[hostId].dbColor = isRunning ? \"Good\" : \"Attention\";\n    }\n    else if (key.includes(\"cpu.util\")) {\n       servers[hostId].cpu = val.toFixed(0) + \"%\";\n       if (val > 90) servers[hostId].cpuColor = \"Attention\";\n       else if (val > 80) servers[hostId].cpuColor = \"Warning\";\n    }\n    else if (key.includes(\"memory\")) {\n       servers[hostId].ram = val.toFixed(0) + \"%\";\n       if (val > 90) servers[hostId].ramColor = \"Attention\";\n       else if (val > 80) servers[hostId].ramColor = \"Warning\";\n    }\n    else if (key.toLowerCase().includes(\"pused\") && !key.includes(\"swap\")) {\n       const free = 100 - val;\n       const match = key.match(/\\[(.*?)\\,/);\n       let diskName = (match && match[1]) ? match[1] : \"Dsk\";\n       diskName = diskName.replace(\"(\", \"\").replace(\")\", \"\");\n       servers[hostId].disks.push({\n           label: diskName,\n           val: free.toFixed(0) + \"%\",\n           color: (free < 10) ? \"Attention\" : (free < 20 ? \"Warning\" : \"Good\")\n       });\n    }\n  }\n});\n\n// --- PROCESSAMENTO DE EVENTOS ---\nconst recentEvents = eventItems.map(evt => {\n    const date = new Date(evt.clock * 1000);\n    const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });\n    let icon = \"â„¹ï¸\";\n    let color = \"Accent\";\n    if (evt.severity == 3) { icon = \"âš ï¸\"; color = \"Warning\"; }\n    if (evt.severity >= 4) { icon = \"ðŸ”¥\"; color = \"Attention\"; }\n    const host = (evt.hosts && evt.hosts[0]) ? evt.hosts[0].name : \"System\";\n    return {\n        \"title\": `${icon} ${timeStr} | ${host}`,\n        \"value\": evt.name\n    };\n});\n\n// --- MONTAGEM VISUAL RESPONSIVA (MOBILE FIRST) ---\nconst serverRows = [];\nfor (const id in servers) {\n  const srv = servers[id];\n  srv.disks.sort((a, b) => a.label.localeCompare(b.label));\n  \n  // Bloco 1: TÃ­tulo e DB (Topo)\n  const headerColumns = [\n      { \"type\": \"Column\", \"width\": \"stretch\", \"items\": [{ \"type\": \"TextBlock\", \"text\": `ðŸ–¥ï¸ ${srv.name}`, \"weight\": \"Bolder\", \"wrap\": true }] }\n  ];\n  if (srv.db) {\n      headerColumns.push({ \"type\": \"Column\", \"width\": \"auto\", \"items\": [{ \"type\": \"TextBlock\", \"text\": `ðŸ—„ï¸ DB: ${srv.db}`, \"color\": srv.dbColor, \"weight\": \"Bolder\", \"size\": \"Small\" }] });\n  }\n\n  // Bloco 2: MÃ©tricas (Meio)\n  const metricsColumns = [\n      { \"type\": \"Column\", \"width\": \"auto\", \"items\": [{ \"type\": \"TextBlock\", \"text\": `ðŸ§  RAM: ${srv.ram}`, \"color\": srv.ramColor, \"size\": \"Small\" }] },\n      { \"type\": \"Column\", \"width\": \"auto\", \"spacing\": \"Large\", \"items\": [{ \"type\": \"TextBlock\", \"text\": `ðŸ”¥ CPU: ${srv.cpu}`, \"color\": srv.cpuColor, \"size\": \"Small\" }] }\n  ];\n\n  // Bloco 3: Discos (Base)\n  const diskItems = srv.disks.length > 0 \n      ? srv.disks.map(d => ({\n          \"type\": \"TextBlock\", \"text\": `ðŸ’¾ ${d.label}: ${d.val}`, \"color\": d.color, \"size\": \"Small\", \"wrap\": true\n        }))\n      : [{ \"type\": \"TextBlock\", \"text\": \"ðŸ’¾ Discos: N/A\", \"isSubtle\": true, \"size\": \"Small\" }];\n\n  // Container do Servidor (Agrupa tudo)\n  serverRows.push({\n      \"type\": \"Container\", \n      \"separator\": true,\n      \"spacing\": \"Medium\",\n      \"items\": [\n          { \"type\": \"ColumnSet\", \"columns\": headerColumns }, // Linha 1\n          { \"type\": \"ColumnSet\", \"columns\": metricsColumns, \"spacing\": \"Small\" }, // Linha 2\n          { \"type\": \"Container\", \"items\": diskItems, \"spacing\": \"Small\" } // Linha 3\n      ]\n  });\n}\n\n// JSON Final\nreturn {\n  \"type\": \"message\",\n  \"attachments\": [{\n    \"contentType\": \"application/vnd.microsoft.card.adaptive\",\n    \"content\": {\n      \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n      \"type\": \"AdaptiveCard\",\n      \"version\": \"1.4\",\n      \"msteams\": { \"width\": \"Full\" },\n      \"body\": [\n        {\n          \"type\": \"Container\", \"style\": \"emphasis\",\n          \"items\": [{\n              \"type\": \"ColumnSet\",\n              \"columns\": [\n                { \"type\": \"Column\", \"width\": \"auto\", \"items\": [{ \"type\": \"TextBlock\", \"text\": \"ðŸš€\", \"size\": \"ExtraLarge\" }] },\n                { \"type\": \"Column\", \"width\": \"stretch\", \"items\": [\n                    { \"type\": \"TextBlock\", \"text\": \"RelatÃ³rio de Infraestrutura\", \"weight\": \"Bolder\", \"size\": \"Large\" },\n                    { \"type\": \"TextBlock\", \"text\": `${new Date().toLocaleDateString('pt-BR')} | Ãšltimas 12h`, \"isSubtle\": true, \"spacing\": \"None\" }\n                ]}\n              ]\n            }]\n        },\n        // Alertas\n        {\n          \"type\": \"Container\",\n          \"items\": [\n            { \"type\": \"TextBlock\", \"text\": \"ðŸš¨ Top Alertas (Ãšltimas 12h)\", \"weight\": \"Bolder\", \"size\": \"Medium\", \"separator\": true, \"color\": \"Attention\" },\n            {\n               \"type\": \"FactSet\",\n               \"facts\": recentEvents.length > 0 ? recentEvents : [{ \"title\": \"Status\", \"value\": \"Nenhum alerta crÃ­tico encontrado âœ…\" }]\n            }\n          ]\n        },\n        // Backups\n        {\n          \"type\": \"Container\",\n          \"items\": [\n            { \"type\": \"TextBlock\", \"text\": \"ðŸ›¡ï¸ Rotinas de Backup\", \"weight\": \"Bolder\", \"size\": \"Medium\", \"separator\": true, \"color\": \"Accent\" },\n            {\n              \"type\": \"FactSet\",\n              \"facts\": [\n                { \"title\": \"Veeam (DB MKT):\", \"value\": backups[\"veeam.status[Bkp_DBMKT_VM]\"] || \"âž–\" },\n                { \"title\": \"Veeam (Zabbix):\", \"value\": backups[\"veeam.status[Zabbix]\"] || \"âž–\" },\n                { \"title\": \"Task (Dump Linux):\", \"value\": backups[\"task.status[Dump_Linux]\"] || \"âž–\" },\n                { \"title\": \"Task (Bkp n8n):\", \"value\": backups[\"task.status[Backup_n8n]\"] || \"âž–\" }\n              ]\n            }\n          ]\n        },\n        // Hosts (A parte nova responsiva)\n        {\n          \"type\": \"Container\",\n          \"items\": [\n            { \"type\": \"TextBlock\", \"text\": \"ðŸ“Š SaÃºde dos Hosts\", \"weight\": \"Bolder\", \"size\": \"Medium\", \"separator\": true, \"color\": \"Accent\" },\n            ...serverRows.length > 0 ? serverRows : [{ \"type\": \"TextBlock\", \"text\": \"Nenhum dado encontrado\", \"isSubtle\": true }]\n          ]\n        }\n      ]\n    }\n  }]\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        384,
        1520
      ],
      "id": "940fcacc-2e3f-4ca9-b46b-dcbce67ecb3c",
      "name": "mensagens1",
      "executeOnce": true
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Config_IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get_Static": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Get_Disks": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "mensagens1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Config_IDs": {
      "main": [
        [
          {
            "node": "Get_Disks",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get_Static",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get_Events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get_Events": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "mensagens1": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "a942b702-192b-4bcf-9503-1da0379b213c",
  "meta": {
    "instanceId": "cda283d70cf8b94453076ed599635e2734cf051745f33cba1dacc3cf2f07ad04"
  },
  "id": "FcGdKelSD7uYVBVr",
  "tags": []
}